<!DOCTYPE html>
<meta charset="utf-8">
<title>Web Speech API Demo</title>

  <style type="text/css">

    body {
      height: 100%;
      margin: 0;
      font-size: 6em;
      font-family: sans-serif;
    }

    #magical-ride {
      padding-top: 200px;
      position: absolute;
      width: 100%;
      height: 100%;
      display: block;      
      text-align: center;
      cursor: pointer;
    }

    .info {
      font-size: 14px;
      text-align: center;
      color: #777;
      display: none;
    }

    #info {
      font-size: 20px;
      text-align: center;
      color: #777;
      visibility: hidden;
    }

  </style>

  <script type="text/javascript" src="mespeak.js"></script>
  <script type="text/javascript" src="zepto.min.js"></script>
  <script type="text/javascript">

    //voice stuff
    meSpeak.loadConfig("mespeak_config.json");
    meSpeak.loadVoice("voices/en/en.json");
  
    function loadVoice(id) {
      var fname="voices/"+id+".json";
      meSpeak.loadVoice(fname, voiceLoaded);
    }

    //speakNow("vagina") and your computer will say "vagina"
    speakNow = function(content) {
            meSpeak.speak(content, {
              amplitude: 100,
              wordgap: 5,
              pitch: 40,
              speed: 135
            });
          };

    //zepto · jQuery stuff
    $(document).ready(function() {
      $('#magical-ride').click(function() {
          startTheMagicalRide();        
      });  
    });
    
    //Magical Ride!
    var step = 0;
    var pin = 0;
    var value = 0;
    var blinduinoIsStillLookin = true;  

    function setStep(n) {
      step = n;
    }  

    function startTheMagicalRide() {
      $('#magical-ride').html("Blinduino is working");
      speakNow("Select an Arduino pin by saying its number in the microphone");
      startButton(event);
    }

    //Voice Recognition stuff
    var final_transcript = '';
    var recognizing = false;
    var ignore_onend;
    var start_timestamp;

    if (!('webkitSpeechRecognition' in window)) {
      upgrade();
    } else {
      //start_button.style.display = 'inline-block';
      var recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = function() {
        recognizing = true;
        showInfo('info_speak_now');        
        //start_img.src = 'mic-animate.gif';
      };

      recognition.onerror = function(event) {
        if (event.error == 'no-speech') {
          //start_img.src = 'mic.gif';
          showInfo('info_no_speech');
          ignore_onend = true;
        }
        if (event.error == 'audio-capture') {
          //start_img.src = 'mic.gif';
          showInfo('info_no_microphone');
          ignore_onend = true;
        }
        if (event.error == 'not-allowed') {
          if (event.timeStamp - start_timestamp < 100) {
            showInfo('info_blocked');
          } else {
            showInfo('info_denied');
          }
          ignore_onend = true;
        }
      };

      recognition.onresult = function(event) {        
      if (step == 0) {                

        for (var i = event.resultIndex; i < event.results.length; ++i) {      
            //final_transcript += event.results[i][0].transcript;      
            result = event.results[i][0].transcript;
            console.log(result);
            $('#magical-ride').html(result);

            pin = Number(result);
            recognition.stop();

            step = 1;

            if (isNaN(pin)) {
              speakNow("that's not a number, can't you see that? say a pin number now");
              setInterval(function(){
                setStep(0);
                recognition.start();                          
              },1000);
            } else if (pin > 13) {
                speakNow("arduino has only 13 pins, you moron");
                setInterval(function(){
                  setStep(0);                 
                  recognition.start();           
              },1000);
              } else {
                speakNow("you selected pin number" + pin);
                recognition.stop();
              }
            }
          }            
        };
      }
       

    function welcomeDude() {
      speakNow("Welcome to Blinduino. Click anywhere to start");
      setInterval(function(){                
                $('#magical-ride').html("Click anywhere to start");
              },3000);
    }  

    function startButton(event) {
      if (recognizing) {
        recognition.stop();
        return;
      }
      final_transcript = '';
      recognition.lang = 'en-GB', 'United Kingdom';
      recognition.start();
      ignore_onend = false;      
      start_img.src = 'mic-slash.gif';
      showInfo('info_allow');
      showButtons('none');
      start_timestamp = event.timeStamp;
    }

  </script>

<body onload="welcomeDude()">
<div id="info">
  <p id="info_start">Click on the microphone icon and begin speaking.</p>
  <p id="info_speak_now">Speak now.</p>
  <p id="info_no_speech">No speech was detected. You may need to adjust your
    <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
      microphone settings</a>.</p>
  <p id="info_no_microphone" style="display:none">
    No microphone was found. Ensure that a microphone is installed and that
    <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
    microphone settings</a> are configured correctly.</p>
  <p id="info_allow">Click the "Allow" button above to enable your microphone.</p>
  <p id="info_denied">Permission to use microphone was denied.</p>
  <p id="info_blocked">Permission to use microphone is blocked. To change,
    go to chrome://settings/contentExceptions#media-stream</p>
  <p id="info_upgrade">Web Speech API is not supported by this browser.
     Upgrade to <a href="//www.google.com/chrome">Chrome</a>
     version 25 or later.</p>
</div>
<div id="magical-ride">

</div>
</body>